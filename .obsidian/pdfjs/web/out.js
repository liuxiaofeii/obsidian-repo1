window.addEventListener("load",function(){var p,u,l="255,255,0",g=[],m="",f=null,y=[],o="rgba(0,0,255,0.3)",a=null,i="",v=[],x=[],w=!1,b=null,S="",q=!1,L=!1,A=0,C=0,h=0,E=0,I=null,P=null,s=0,d=0,k="",T="",c=null,r=1,M=!1,V=!0,N=null,z=!1,O="",R={"zh-cn":{page:"页"},zn:{page:"Page"}};Element.prototype.hasClass=function(e){return this.classList.contains(e)};let D='<svg t="1629004332697"  viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3111" width="16" height="16"><path d="M914.56 463.78z m-110.53 0q0 30.34 14.63 55.81 14.63 25.46 40.63 40.09 26 14.63 54.72 14.63t55.26-14.63q26.55-14.63 40.63-40.09 14.09-25.47 14.09-55.27 0-29.8-14.09-55.27-14.08-25.46-40.63-40.63-26.55-15.17-55.26-15.17-28.72 0-54.72 15.17t-40.63 40.63q-14.63 25.47-14.63 54.73z m110.53 358.67z m-110.53 0q0 29.26 14.63 54.72 14.63 25.47 40.63 40.63 26 15.17 54.72 15.17t55.26-15.17q26.55-15.17 40.63-40.63 14.09-25.46 14.09-55.26 0-29.8-14.09-54.73-14.08-24.92-40.63-39.55Q942.72 713 914.01 713q-28.72 0-54.72 14.63t-40.63 39.55q-14.63 24.93-14.63 55.27z m-284.99 0z m-109.44 0q0 46.6 30.88 78.02 30.88 31.42 78.55 32.51 46.6-1.09 78.03-32.51 31.42-31.42 32.5-78.02-1.08-47.68-32.5-78.56-31.43-30.88-78.03-30.88-47.67 0-78.55 30.88-30.88 30.88-30.88 78.56z m109.44-358.67z m-109.44 0q0 47.68 30.88 78.56 30.88 30.88 78.55 31.97 46.6-1.09 78.03-31.97 31.42-30.88 32.5-78.56-1.08-46.59-32.5-77.47-31.43-30.88-78.03-33.06-47.67 2.17-78.55 33.06-30.88 30.88-30.88 77.47z m504.96-353.25z m-110.53 0q0 29.25 14.63 54.72t40.63 40.63q26 15.17 54.72 15.17t55.26-15.17q26.55-15.17 40.63-40.63 14.09-25.47 14.09-55.26 0-29.8-14.09-54.72-14.08-24.93-40.63-40.09Q942.72 0.01 914.01 0.01q-28.72 0-54.72 15.17t-40.63 40.09q-14.63 24.92-14.63 55.27zM109.44 822.45zM0 822.45q1.08 29.26 15.17 54.72 14.09 25.47 40.09 40.63 26 15.17 54.72 15.17t55.27-15.17q26.55-15.17 40.63-40.63 14.09-25.46 15.17-54.72-2.16-47.68-33.05-78.56-30.88-30.88-78.56-30.88-46.59 0-77.47 30.88Q1.09 774.77 0.01 822.45z" p-id="3112"></path></svg>',J='<svg t="1632228228676"  viewBox="0 0 1214 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15810" width="12" height="12"><path d="M964.352982 196.442274H250.01744A53.575166 53.575166 0 0 0 196.442274 250.01744v339.309382A53.575166 53.575166 0 0 0 250.01744 642.901988h214.300663l117.508196 117.508197a35.716777 35.716777 0 0 0 50.717824 0L750.052319 642.901988h214.300663a53.575166 53.575166 0 0 0 53.575166-53.575166V250.01744A53.575166 53.575166 0 0 0 964.352982 196.442274z" fill="#FFC824" p-id="15811"></path><path d="M607.185211 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM383.955354 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM830.415068 477.53331a35.716777 35.716777 0 0 1-35.716777-35.716777v-53.575166a35.716777 35.716777 0 1 1 71.433554 0v53.575166a35.716777 35.716777 0 0 1-35.716777 35.716777zM361.453784 71.433554h-17.858388a35.716777 35.716777 0 0 1 0-71.433554h17.858388a35.716777 35.716777 0 0 1 0 71.433554z" fill="#6B400D" p-id="15812"></path><path d="M607.185211 1024a107.150331 107.150331 0 0 1-75.719567-31.430764l-153.224974-153.224974H142.867108a142.867108 142.867108 0 0 1-142.867108-142.867108V142.867108a142.867108 142.867108 0 0 1 142.867108-142.867108h53.575166a35.716777 35.716777 0 0 1 0 71.433554H142.867108a71.433554 71.433554 0 0 0-71.433554 71.433554v553.610046a71.433554 71.433554 0 0 0 71.433554 71.433554h250.01744a35.716777 35.716777 0 0 1 25.358912 10.357865l163.582839 163.940007a35.716777 35.716777 0 0 0 50.717824 0l163.582839-163.940007a35.716777 35.716777 0 0 1 25.358912-10.357865h250.01744a71.433554 71.433554 0 0 0 71.433554-71.433554V142.867108a71.433554 71.433554 0 0 0-71.433554-71.433554H535.751657a35.716777 35.716777 0 0 1 0-71.433554h535.751657a142.867108 142.867108 0 0 1 142.867108 142.867108v553.610046a142.867108 142.867108 0 0 1-142.867108 142.867108h-235.373562l-153.224973 153.224974a107.150331 107.150331 0 0 1-75.719568 31.430764z" fill="#6B400D" p-id="15813"></path></svg>';document.querySelector(".icon-toggle"),document.querySelector(".viewerSider"),document.querySelector(".icon-zoomIn"),document.querySelector(".icon-zoomOut");var H=document.querySelector(".annotate-menu"),_=document.querySelector(".viewerSiderAnnotate"),e=document.querySelector(".icon-createImage");document.querySelector(".icon-info");let B=document.getElementById("viewerContainer");var F=document.querySelector(".add-comment"),X=F.querySelector("textarea");$("body").on("click","#viewThumbnail",function(){$(".viewerSiderAnnotate").addClass("hidden"),$("#thumbnailView").removeClass("hidden"),$("#outlineView").addClass("hidden"),$("#showAnnotation").removeClass("toggled")}),$("body").on("click","#viewOutline",function(){$(".viewerSiderAnnotate").addClass("hidden"),$("#thumbnailView").addClass("hidden"),$("#outlineView").removeClass("hidden"),$("#showAnnotation").removeClass("toggled")}),$("body").on("click","#showAnnotation",function(){$(".viewerSiderAnnotate").removeClass("hidden"),$("#thumbnailView").addClass("hidden"),$("#outlineView").addClass("hidden"),$("#viewThumbnail").removeClass("toggled"),$("#viewOutline").removeClass("toggled"),$(this).addClass("toggled"),re()}),H.onclick=e=>{var t,n,a,r,o=e.target.closest(".annoate-btn");o&&("highlight"==(t=o.getAttribute("title"))?(l=o.getAttribute("data-color"),f?(n=f.getAttribute("data-id"),document.querySelectorAll(`.mm-highlight[data-id="${n}"]`).forEach(e=>{e&&(e.style.backgroundColor=`rgb(${l})`)}),g.forEach(e=>{var t,a;e.id==n&&(t=JSON.parse(e.text),a=l.split(","),t.color={r:a[0],g:a[1],b:a[2]},e.text=JSON.stringify(t))}),ne()):ae()):"comment"==t||("delete annotate"==t?f&&function(){{var a;f&&(a=f.getAttribute("data-id"),g.forEach((e,t)=>{e.id==a&&g.splice(t,1)}),document.querySelectorAll(`.mm-highlight[data-id="${a}"]`).forEach(e=>{e&&e.parentElement&&e.parentElement.removeChild(e)}),ne())}}():"copy text"==t?(f?(a="","highlight"==f.getAttribute("data-type")&&(a=f.getAttribute("data-text"))):a=z||q?Q.selectText:j.current[0].text,window.parent.postMessage({type:"copyText",text:a,_viewMark:m},"*"),Q={},j={},y.length&&(y.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),y=[])):"add note"==t&&(e=e.touches?(r=e.touches[0].pageX,e.touches[0].pageY):(r=e.pageX,e.pageY),F.style.left=`${r-20}px`,F.style.top=`${e}px`,F.style.display="block",F.selectId=f.getAttribute("data-id"),g.forEach(e=>{e.id!=F.selectId||(e=JSON.parse(e.text)).contents&&(X.value=e.contents)}))),H.style.display="none",f=null,y=[])},e.onclick=()=>{w=!w},document.onkeydown=function(e){var t=e.altKey,a=e.ctrlKey||e.metaKey;!t||"y"!=e.key&&"Y"!=e.key||(l="247,255,0",ae()),!t||"g"!=e.key&&"G"!=e.key||(l="125,240,102",ae()),!t||"b"!=e.key&&"B"!=e.key||(l="143,222,249",ae()),!t||"p"!=e.key&&"P"!=e.key||(l="247,153,209",ae()),!t||"r"!=e.key&&"R"!=e.key||(l="253,73,73",ae()),!t||"i"!=e.key&&"I"!=e.key||(w=!w),!a||"c"!=e.key&&"C"!=e.key||(n=document.querySelector(".annoate-btn.copy"))&&n.click();var n,e=e.key.toLowerCase();!t||"delete"!=e&&"backspace"!=e||(n=document.querySelector(".annoate-btn.delete"))&&n.click()},_.onclick=e=>{var t=e.target.closest(".annotate-item");if(t){var a=t.getAttribute("data-id"),t=document.querySelector(".annotate-item.active");if(t){if(e.target.closest(".annotate-item-note"))return;t.classList.remove("active"),t.querySelector(".annotate-item-note").blur(),t.querySelector(".annotate-item-note").setAttribute("contenteditable",!1)}t=document.querySelector(`.annotate-item[data-id="${a}"]`);t&&t.classList.add("active"),t.querySelector(".annotate-item-note").setAttribute("contenteditable",!0),H.style.display="none",F.style.display="none",f=null,y=[],j={},ce(a)}},window.addEventListener("message",function(e){switch(e.data.type){case"openPDF":e.data._viewMark&&(m=e.data._viewMark);try{k=e.data.pdfName,p=e.data.basename,g=e.data.annotations,e.data.openProtocol,i=e.data.id,M=e.data.isMobile,T=e.data.mdPath,u=e.data.imageFolder,O=e.data.language,S=e.data.mdId,e.data.top&&(s=e.data.top),e.data.bottom&&(s=e.data.bottom),re(),V&&(M&&(B.addEventListener("touchstart",K),B.addEventListener("touchmove",U),B.addEventListener("touchend",ee)),B.addEventListener("mousedown",K),B.addEventListener("mousemove",U),B.addEventListener("mouseup",ee),V=!1),setTimeout(function(){PDFViewerApplication&&(PDFViewerApplication.open(e.data.data).then(()=>{try{window.pdfViewer=PDFViewerApplication.pdfViewer,window.extractor=new Extractor(pdfViewer),pdfViewer._currentPage=1,PDFViewerApplication.pdfDocument.getData().then(e=>{M||(N=new pdfAnnotate.AnnotationFactory(e)),pdfViewer.currentScaleValue="page-width"}),e.data.id&&ce(e.data.id)}catch(e){}}).catch(function(e){}),PDFViewerApplication.eventBus.on("pagerendered",se))},1e3)}catch(e){}break;case"closePDF":break;case"showAnnotate":ce(e.data.id);break;case"exportAnnotatePDF":var t,d=document.querySelector("#viewer .page").clientWidth;new Date;setTimeout(()=>{g.forEach(e=>{var t,i,l=JSON.parse(e.text);N&&(1!=r&&N.deleteAnnotation(l.id),t=l.relateRect,i={page:l.page,rect:l.rect,contents:function(e){let t=[];for(var a of e)a=a.charCodeAt(0),t.push(String.fromCharCode(a>>8)),t.push(String.fromCharCode(255&a));return"þÿ"+t.join("")}(l.contents||""),author:"",color:l.color,opacity:.8,id:l.id,quadPoints:[],fill:"",font:"Noto Sans CJK SC Medium"},t.forEach(e=>{var t=parseInt(e.x*d+""),a=parseInt(e.y*d+""),n=parseInt(e.width*d+""),r=parseInt(e.height*d+""),o=pdfViewer._pages[l.page].viewport.convertToPdfPoint(t,a),e=o[0],o=o[1],a=pdfViewer._pages[l.page].viewport.convertToPdfPoint(t+n,a+r),r=a[0],a=a[1];i.quadPoints.push(e,a,r,a,e,o,r,o)}),"highlight"==e.type?(i.rect||(i.rect=i.quadPoints.slice(0,4)),i.rect.length<4||N.createHighlightAnnotation(i)):(i.fill=l.color,i.opacity=.3,i.quadPoints.length&&(i.rect=[i.quadPoints[2],i.quadPoints[3],i.quadPoints[4],i.quadPoints[5]],N.createSquareAnnotation(i))))});new Date;t=N.write(),r++,setTimeout(function(){window.parent.postMessage({type:"exportAnnotatePDF",pdfData:t,_viewMark:m},"*")},200)},200);break;case"getAnnotations":N&&N.getAnnotations().then(e=>{window.parent.postMessage({type:"gteAnnotations",_viewMark:m},"*")});break;case"saveImagePath":var a=e.data.id,n=e.data.imagePath;g.forEach(e=>{var t;e.id==a&&((t=JSON.parse(e.text)).imageAbsolutePath=n,e.text=JSON.stringify(t))}),ne();break;case"useOldVersion":z=!0;break;case"useNewVersion":z=!1}},!1);var Y={yellow:"247,255,0",green:"125,240,102",blue:"143,222,249",pink:"247,153,209",red:"253,73,73"},W=!1;function K(e){var t,a,n,r,o,i,l,d=e.target;d.hasClass("comment-bar")||d.closest(".comment-bar")?(l=(d.hasClass("comment-bar")?d:d.closest(".comment-bar")).getAttribute("data-title"),(n=d.closest(".annotate"))&&(t=parseInt(n.style.left),a=parseInt(n.style.top),n=parseInt(n.clientHeight),r=d.closest(".page"),(o=document.createElement("div")).classList.add("annotate-comment"),o.style.left=t+"px",o.style.top=a+n+10+"px",o.style.minWidth="100px",o.style.minHeight="80px",o.style.position="absolute",o.style.padding="10px",o.style.zIndex=200,o.style.backgroundColor="rgb(242 253 184)",o.style.color="#333",o.innerText=l||"",o.style.paddingTop="4px",r.appendChild(o),(i=document.createElement("span")).innerText="X",i.style.float="right",i.style.position="absolute",i.style.color="red",i.style.right="10px",i.style.top="10px",i.style.fontSize="12px",i.style.cursor="pointer",o.appendChild(i),i.onclick=function(){i.onclick=null,r.removeChild(o),o.innerText="",o=null})):(W=!0,(l=oe(e))&&(extractor.getSortIndex(l),function(e,t){C=t.touches?(A=t.touches[0].pageX,t.touches[0].pageY):(A=t.pageX,t.pageY);{var a,n;t.target.closest(".page")&&(a=t.target.closest(".page"),n=a.getAttribute("data-page-number"),pdfViewer._currentPage=parseInt(n),P=a.querySelector(".textLayer"))}Q.current=e,Q.id="",y.length&&(y.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),j={},y=[]);{var r,o;document.querySelectorAll(".annotate.active").forEach(e=>{e&&e.classList.remove("active")}),f=null,q=!1,H.style.display="none",F.style.display="none",t.target.closest(".mm-highlight")&&(r=(f=t.target.closest(".mm-highlight")).getAttribute("data-id"),document.querySelectorAll(`.mm-highlight[data-id="${r}"]`).forEach(e=>{e&&e.classList.add("active")}),(s=document.querySelector(".annotate-item.active"))&&s.classList.remove("active"),(d=document.querySelector(`.annotate-item[data-id="${r}"]`))&&d.classList.add("active"),o=null,g.forEach(e=>{e.id==r&&(o=e)}),o&&window.parent.postMessage({type:"showMindmapAnnotate",id:r,data:o,annotateType:o.type,mdId:S,_viewMark:m},"*"))}w||(v=[],x=[]);if(t.target.hasClass("annotate-head")||t.target.hasClass(".annotate-resize")||t.target.closest(".annotate-resize")){var i=t.target.closest(".annotate");c=t.target.hasClass("annotate-head")?"move":"resize",b={ele:i,left:parseInt(i.style.left),top:parseInt(i.style.top),width:i.clientWidth,height:i.clientHeight,type:c}}else{var l,d,s=pe();d=M?(l=A-s.left,C-s.top):(l=t.pageX-s.left,t.pageY-s.top);var i=l,c=d;x.push(l),x.push(d);s=pdfViewer._pages[pdfViewer._currentPage-1].viewport.convertToPdfPoint(l,d);if(l=s[0],d=s[1],v.push(l),v.push(d),w){t.preventDefault(),L=!0,B.style.cursor="pointer",(I=document.createElement("div")).classList.add("annotate"),I.classList.add("mm-highlight"),I.setAttribute("data-type","rect"),I.setAttribute("style",`position:absolute;background:#f9e9cc;left:${i-2}px;top:${c-2}px`);c=document.createElement("div");c.classList.add("annotate-head"),I.appendChild(c);var p,c=document.createElement("div");c.classList.add("annotate-resize"),I.appendChild(c),c.innerHTML=D,P.querySelector("annotateLayer-extend")?p=P.querySelector("annotateLayer-extend"):(p=document.createElement("div"),P.appendChild(p)),p.appendChild(I);for(var u=0;u<P.children.length;u++){var h=P.children[u];h.style&&(h.style.userSelect="none",h.style.cursor="pointer")}}}}(ie(l),e)))}var j={},Q={};function n(e){j.current=e}function U(e){if(W)return b?(e.preventDefault(),E=e.touches?(h=e.touches[0].pageX-A,e.touches[0].pageY-C):(h=e.pageX-A,e.pageY-C),void("move"==b.type?(b.ele.style.left=b.left+h+"px",b.ele.style.top=b.top+E+"px"):(b.ele.style.width=b.width+h+"px",b.ele.style.height=b.height+E+"px"))):L&&w?(e.preventDefault(),E=e.touches?(h=e.touches[0].pageX-A,e.touches[0].pageY-C):(h=e.pageX-A,e.pageY-C),I.style.width=h-2+"px",void(I.style.height=E-2+"px")):void(z||(e=oe(e))&&function(e){let t=document.getElementById("viewer");t.classList.remove("cursor-pointer"),t.classList.remove("cursor-text"),t.classList.remove("cursor-text-selecting"),Q.current&&(j.current&&j.current.length?n(function(e,t){if(!e.length)return[];let a=e.find(e=>e.anchor),n={pageIndex:a.position.pageIndex,offset:a.anchorOffset},r={pageIndex:(a=e.find(e=>e.head)).position.pageIndex,offset:a.headOffset};if("left"===t)r.offset--;else if("right"===t)r.offset++;else if("up"===t){if(r.offset=window.extractor.getPrevLineClosestOffset(r.pageIndex,r.offset),null===r.offset)return[]}else if("down"===t){if(r.offset=window.extractor.getNextLineClosestOffset(r.pageIndex,r.offset),null===r.offset)return[]}else"object"==typeof t&&(t=t,r=t);return le(n,r)}(j.current,e)):n(le(Q.current,e)));(function(e){y.length&&(y.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),y=[]);{var t,a,n,r;e&&e.current&&e.current.length&&e.current[0].position&&(e.current[0].position=function(e){var t=pdfViewer.getPageView(e.pageIndex).viewport;return function(e,o){{if(e.rects)return{pageIndex:e.pageIndex,rects:e.rects.map(e=>{var[t,a]=o.convertToViewportPoint(e[0],e[1]),[n,e]=o.convertToViewportPoint(e[2],e[3]);return[Math.min(t,n),Math.min(e,a),Math.max(t,n),Math.max(e,a)]})};if(e.paths)return{pageIndex:e.pageIndex,width:e.width*o.scale,paths:e.paths.map(t=>{let a=[];for(let e=0;e<t.length-1;e+=2){var n=t[e],r=t[e+1];a.push(...o.convertToViewportPoint(n,r))}return a})}}}(e,t)}(e.current[0].position),t=e.current[0].position.rects,e.current[0].position.rects.map(e=>{e[1]&&(e[1]=e[1]-s),e[3]&&(e[3]=e[3]+d)}),n=e.current[0].position.pageIndex+1,(r=B.querySelector(`[data-page-number="${n}"]`).querySelector(".textLayer"))&&(r.querySelector(".annotateLayer-extend")?a=r.querySelector(".annotateLayer-extend"):((a=document.createElement("div")).classList.add("annotateLayer-extend"),r.appendChild(a)),n=e.current[0].text,r=de(),e.current[0].id=r,t&&t.length&&Z(t,a,n,r)))}})(j),G()}(ie(e)))}function G(){document.selection&&document.selection.empty?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()}function Z(e,a,n,r){e.forEach(e=>{var t=document.createElement("div");t.classList.add("mm-highlight"),t.classList.add("annotate"),t.style.left=e[0]+"px",t.style.top=e[1]+"px",t.style.width=e[2]-e[0]+"px",t.style.height=e[3]-e[1]+"px",t.style.backgroundColor=`${o}`,t.setAttribute("data-text",n),t.setAttribute("data-type","highlight"),t.setAttribute("data-id",r),y.push(t),a.appendChild(t)})}function ee(e){var t,a,n,r,o,i,l,d=document.querySelector("#viewer .page").clientWidth;if(B.style.cursor="auto",b&&!w){var s=b.ele.getAttribute("data-id"),c="";return g.forEach(e=>{var t,a,n;e.id==s&&(t=JSON.parse(e.text),e.width=b.ele.clientWidth,e.height=b.ele.clientHeight,a=parseInt(b.ele.style.left),n=parseInt(b.ele.style.top),c=t.path,n=[{x:a/d,y:n/d,width:e.width/d,height:e.height/d}],t.relateRect=n,e.text=JSON.stringify(t))}),ue(c,{left:parseInt(b.ele.style.left),top:parseInt(b.ele.style.top),width:b.ele.clientWidth,height:b.ele.clientHeight},!1,P,b.ele,{id:s}),b=null,void(W=L=!1)}L&&w&&(w=!1,t={id:de(),page:pdfViewer._currentPage-1,rect:v.slice(),contents:"",author:"",color:{r:249,g:233,b:204},opacity:1,path:"",relateRect:null,pdfName:k,pageWidth:d},a=parseInt(I.style.left),n=parseInt(I.style.top),r=h,o=E,i=+new Date,ue(u?u+"/"+i+".png":k.startsWith("file:")?(l=T.lastIndexOf("/"),T.substr(0,l+1)+i+".png"):(l=k.lastIndexOf("/"),k.substr(0,l+1)+p+"-"+i+".png"),{left:a,top:n,width:r,height:o},!0,P,I,t)),W=L=!1,z&&(te(),G()),function(e){{var t,a;a=e.changedTouches?(t=e.changedTouches[0].pageX,e.changedTouches[0].pageY):(t=e.pageX,e.pageY)}!f;setTimeout(()=>{te(0,!0),G(),(y.length||f)&&(H.style=`left:${t-20}px;top:${a+20}px`,H.style.display="flex")},20)}(e)}function te(e,t){var a=window.getSelection();if(!a.isCollapsed){for(var n=a.getRangeAt(0),r=n.getClientRects(),o="",i=n.cloneContents(),l=0;l<i.children.length;l++)o+=i.children[l].textContent+" ";var o=(o=o.trim())||a.toString(),r=function(e){for(var t={1:[e[0]]},a=1,n=e[0].bottom,r=1;r<e.length;r++){t[a]||(t[a]=[]);var o=e[r].height;e[r].top<n&&e[r].bottom<n+o/3||(t[++a]||(t[a]=[]),n=e[r].bottom),t[a].push(e[r])}var i,l=[];for(i in t){let a,n,r,o;t[i].forEach((e,t)=>{0==t?(a=e.x,n=e.y,r=e.bottom,o=e.right):(e.x<a&&(a=e.x),e.y<n&&(n=e.y),e.bottom>r&&(r=e.bottom),e.right>o&&(o=e.right))});var d={x:a,y:n,top:a,left:n,bottom:r,right:o,width:o-a,height:r-n};l.push(d)}return l}(r=function(t){var a=[];for(let e=0;e<t.length;e++)for(var n,r,o=e;o<t.length;o++)e!=o&&(n=t[e],r=t[o],n.x<=r.x&&n.y<=r.y&&n.bottom>=r.bottom&&n.right>=r.right&&a.push(o));var i=[];{if(a.length){for(let e=0;e<t.length;e++)-1==a.indexOf(e)&&i.push(t[e]);return i}return t}}(r)),d=pe(),i=[];r.forEach(e=>{var t=e.x-d.left,a=e.y-d.top;i.push([t,a,t+e.width,a+e.height])});r=Q.current.pageIndex;Q.rects=i,Q.id=de(),Q.selectText=o;var s,r=r+1,r=B.querySelector(`[data-page-number="${r}"]`).querySelector(".textLayer");r&&(r.querySelector(".annotateLayer-extend")?s=r.querySelector(".annotateLayer-extend"):((s=document.createElement("div")).classList.add("annotateLayer-extend"),r.appendChild(s)),y.length&&(y.forEach(e=>{e.parentElement&&e.parentElement.removeChild(e)}),y=[]),Z(i,s,o,Q.id),t&&(q=!0))}}function ae(){var e,t,a,n,r,o,i=[];o=z||q?(r=Q.rects,e=Q.selectText,t=Q.id,Q.current.pageIndex):(r=j.current[0].position.rects,e=j.current[0].text,t=j.current[0].id,j.current[0].position.pageIndex),t&&(r.forEach(e=>{i.push({x:e[0],y:e[1],width:e[2]-e[0],height:e[3]-e[1]})}),a=`rgb(${l})`,y.forEach(e=>{e.style.backgroundColor=a}),r=l.split(","),n=document.querySelector("#viewer .page").clientWidth,r={selectText:e,id:t,relateRect:i=i.map(e=>({x:e.x/n,y:e.y/n,width:e.width/n,height:e.height/n})),page:o,quadPoints:null,color:{r:r[0],g:r[1],b:r[2]},pdfName:k},o={selectText:e,id:t,type:"highlight",text:JSON.stringify(r),pdfName:k,page:o,createTime:+new Date},g.push(o),ne(o),y=[],j={},Q.id="",H.style.display="none",F.style.display="none",q=!1)}function ne(e){g.sort((e,t)=>e.page-t.page),re(),window.parent.postMessage({type:"saveAnnotations",_viewMark:m,annotations:g,newAnnotate:e,mdId:S},"*")}function re(){_.innerHTML="",g.forEach(e=>{var t=document.createElement("div");t.classList.add("annotate-item"),t.setAttribute("data-id",e.id);var a=document.createElement("div");a.classList.add("annotate-item-container"),t.appendChild(a);var n=document.createElement("div");n.classList.add("annotate-item-header"),r=("zh-cn"==O?R[O]:R.zn).page,n.innerHTML=`${r} ${e.page+1}`;var r,o=document.createElement("div");o.classList.add("annotate-item-content"),"highlight"==e.type?o.innerHTML=`
					<blockquote>
						${e.selectText||""}
					</blockquote>
			   `:(r=`<img src="${(i=JSON.parse(e.text)).imageAbsolutePath||i.path}"/>`,o.innerHTML=r);var i=JSON.parse(e.text),e=document.createElement("div");e.classList.add("annotate-item-note"),e.innerText=`${i.contents||""}`;var l,i=i.color,d=`${i.r},${i.g},${i.b}`,s="mm-highlight-black";for(l in Y)Y[l]==d&&(s=`mm-highlight-${l}`);t.classList.add(s),a.appendChild(n),a.appendChild(o),a.appendChild(e),_.appendChild(t)})}function t(e,t){var a,n=B.querySelector(`.annotate[data-id="${e}"]`);n&&(e=n.querySelector(".comment-bar"),t?e?e.setAttribute("data-title",t):((a=document.createElement("span")).classList.add("comment-bar"),a.style="position:abaolute;left:-8px;top:-6px;z-index:120;",a.innerHTML=J,a.setAttribute("data-title",t),n.appendChild(a)):(a=n.querySelector(".comment-bar"))&&n.removeChild(a),ne())}function oe(e){let t=function(e){var t=e.closest("#viewer > .page")||e.closest("#viewer > .spread > .page");if(!t)return null;e=parseInt(t.dataset.pageNumber);return{node:t,number:e}}(e.target);if(!t)return null;var a=t.node.getBoundingClientRect(),n=(e.touches?e.touches[0]:e).clientX,e=(e.touches?e.touches[0]:e).clientY,n=n+t.node.scrollLeft-a.left-9,a=e+t.node.scrollTop-a.top-10;return{pageIndex:t.number-1,rects:[[n,a,n,a]]}}function ie(e){var r,t=pdfViewer.getPageView(e.pageIndex).viewport;return r=t,{pageIndex:e.pageIndex,rects:e.rects.map(e=>{var[t,a]=r.convertToPdfPoint(e[0],e[1]),[n,e]=r.convertToPdfPoint(e[2],e[3]);return[Math.min(t,n),Math.min(e,a),Math.max(t,n),Math.max(e,a)]})}}$("body").on("blur",".annotate-item-note",e=>{var e=e.target,a=e.innerText,n=e.closest(".annotate-item").getAttribute("data-id");n&&(g.forEach(e=>{var t;e.id==n&&((t=JSON.parse(e.text)).contents=a,t.commentTime=+new Date,e.text=JSON.stringify(t))}),t(n,a))}),X.onblur=()=>{var a=F.selectId;X.value&&(g.forEach(e=>{var t;e.id==a&&((t=JSON.parse(e.text)).contents=X.value,t.commentTime=+new Date,e.text=JSON.stringify(t))}),t(a,X.value),X.value="",F.selectId="")};function le(r,o){let i=[];var e=Math.min(r.pageIndex,o.pageIndex),t=Math.max(r.pageIndex,o.pageIndex),l=r.pageIndex>o.pageIndex;for(let n=e;n<=t;n++){let e,t;n===r.pageIndex&&(e=void 0!==r.offset?r.offset:[r.rects[0][0],r.rects[0][1]]),n===o.pageIndex&&(t=void 0!==o.offset?o.offset:[o.rects[0][0],o.rects[0][1]]);let a=window.extractor.extractRange({pageIndex:n,anchor:e,head:t,reverse:l});if(!a)return[];if(n===r.pageIndex&&(a.anchor=!0),n===o.pageIndex&&(a.head=!0),!a.collapsed){let e=pdfViewer.getPageView(a.position.pageIndex).viewport.viewBox[3]-a.position.rects[0][3];e<0&&(e=0);let t=Math.min(a.anchorOffset,a.headOffset);a.sortIndex=[n.toString().slice(0,5).padStart(5,"0"),t.toString().slice(0,6).padStart(6,"0"),Math.floor(e).toString().slice(0,5).padStart(5,"0")].join("|")}i.push(a)}return i}function de(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()}function se(e){var t=e.pageNumber;setTimeout(()=>{!function(e){a&&clearInterval(a);a=null,g&&g.length&&function(e,d){var s=document.querySelector("#viewer .page").clientWidth;document.querySelectorAll(`.page[data-page-number='${d}'] .mm-highlight`).forEach(e=>{e&&e.parentNode.removeChild(e)}),e.forEach(r=>{var o,e,t,i=JSON.parse(r.text),a=i.relateRect,l=`rgb(${i.color.r},${i.color.g},${i.color.b})`;i.contents&&(o=i.contents),i.page+1==d&&(1<a.length?a.forEach((e,t)=>{var a=document.createElement("div");a.classList.add("mm-highlight"),a.classList.add("annotate"),a.setAttribute("data-type",r.type),"highlight"==r.type&&a.setAttribute("data-text",i.selectText||""),a.style=`background:${l};width:${e.width*s}px;height:${e.height*s}px;position:absolute;cursor:pointer;left:${e.x*s}px;top:${e.y*s}px;`,a.setAttribute("data-id",r.id);var n,e=document.querySelector(`.page[data-page-number='${d}'] .textLayer`);e.querySelector(".annotateLayer-extend")?n=e.querySelector(".annotateLayer-extend"):((n=document.createElement("div")).classList.add("annotateLayer-extend"),e.appendChild(n)),n.appendChild(a),o&&0==t&&((t=document.createElement("span")).classList.add("comment-bar"),a.style.background,t.style="position:abaolute;left:-8px;top:-6px;z-index:120;",t.innerHTML=J,t.setAttribute("data-title",o),a.appendChild(t))}):((a=document.createElement("div")).setAttribute("data-id",i.id),a.setAttribute("data-type",r.type),a.classList.add("mm-highlight"),a.classList.add("annotate"),"highlight"==r.type&&a.setAttribute("data-text",i.selectText||""),"rect"==r.type&&(a.setAttribute("data-path",i.path),(e=document.createElement("div")).classList.add("annotate-head"),a.appendChild(e),(e=document.createElement("div")).classList.add("annotate-resize"),a.appendChild(e),e.innerHTML=D),i.relateRect&&i.relateRect.length&&(a.style=`background:${l};width:${i.relateRect[0].width*s}px;height:${i.relateRect[0].height*s}px;position:absolute;cursor:pointer;left:${i.relateRect[0].x*s}px;top:${i.relateRect[0].y*s}px;`,(e=document.querySelector(`.page[data-page-number='${d}'] .textLayer`)).querySelector(".annotateLayer-extend")?t=e.querySelector(".annotateLayer-extend"):((t=document.createElement("div")).classList.add("annotateLayer-extend"),e.appendChild(t)),t.appendChild(a)),o&&((t=document.createElement("span")).classList.add("comment-bar"),a.style.background,t.style="position:abaolute;left:-8px;top:-6px;z-index:120;",t.innerHTML=J,t.setAttribute("data-title",o),a.appendChild(t))))}),function(e){var a,n,t,r;i&&(a=i,g&&0!=g.length&&(g.filter(e=>{var t=JSON.parse(e.text);return e.id==a&&(n=parseInt(t.page)+1,!0)}).length&&((t=document.querySelector(`.textLayer .mm-highlight[data-id = '${a}']`))?(pdfViewer.currentPageNumber=n,pdfViewer._currentPage=pdfViewer.currentPageNumber,r=parseInt(t.style.top),c&&clearTimeout(c),c=setTimeout(()=>{var e=document.querySelector("#viewerContainer");e.scrollTop=e.scrollTop+r-100,document.querySelectorAll(`.textLayer .mm-highlight[data-id = '${a}']`).forEach(e=>{e&&e.classList.add("active")})},0)):(pdfViewer.currentPageNumber=n,pdfViewer._currentPage=n,c&&clearTimeout(c),this.setTime=setTimeout(()=>{var t,e=document.querySelector(`.textLayer .mm-highlight[data-id = '${a}']`);e&&(t=parseInt(e.style.top),setTimeout(()=>{var e=document.querySelector("#viewerContainer");e.scrollTop=e.scrollTop+t-100},30),document.querySelectorAll(`.textLayer .mm-highlight[data-id = '${a}']`).forEach(e=>{e&&e.classList.add("active")}))},0))),n==e&&(i="")))}(d)}(g,e)}(t)},10)}function ce(t){var a,e,n,r;g.length&&(a=null,g.forEach(e=>{e.id==t&&(a=e)}),a&&(document.querySelectorAll(".mm-highlight.active").forEach(e=>{e.classList.remove("active")}),(r=document.querySelector(`.mm-highlight[data-id = '${t}']`))?(e=r.closest(".page").getAttribute("data-page-number"),pdfViewer.currentPageNumber=parseInt(e),n=parseInt(r.style.top),setTimeout(()=>{var e=document.querySelector("#viewerContainer");e.scrollTop=e.scrollTop+n-60,isShowAnnotate=!1},100),document.querySelectorAll(`.mm-highlight[data-id = '${t}']`).forEach(e=>{e.classList.add("active")}),i=""):(i=t,r=JSON.parse(a.text),pdfViewer.currentPageNumber=parseInt(r.page)+1)))}function pe(){if(0<=pdfViewer._currentPage){var e=document.querySelector(`.page[data-page-number="${pdfViewer._currentPage}"]`);if(e){e=e.querySelector("canvas").getBoundingClientRect();return{top:e.top,left:e.left}}return{top:0,left:0}}return{left:0,top:0}}function ue(e,t,a,n,r,o){var i=document.querySelector("#viewer .page").clientWidth,l=document.createElement("canvas");l.width=t.width,l.height=t.height;var d=l.getContext("2d"),s=n.closest(".page").querySelector("canvas"),n=(window.devicePixelRatio||1)/(d.webkitBackingStorePixelRatio||d.mozBackingStorePixelRatio||d.msBackingStorePixelRatio||d.oBackingStorePixelRatio||d.backingStorePixelRatio||1);d.drawImage(s,t.left*n,t.top*n,t.width*n,t.height*n,0,0,t.width,t.height);l=function(e){for(var t=window.atob(e),a=t.length,n=new Uint8Array(a),r=0;r<a;r++)n[r]=t.charCodeAt(r);return n.buffer}(l.toDataURL().replace(/^data:image\/\w+;base64,/,"")),i=[{x:t.left/i,y:t.top/i,width:t.width/i,height:t.height/i}];o.relateRect=i,o.pdfName=k,o.path=e,a&&(r.setAttribute("data-id",o.id),r.setAttribute("data-path",e),g.push({id:o.id,text:JSON.stringify(o),type:"rect",page:o.page,width:t.width,height:t.height,pdfName:k})),window.parent.postMessage({type:"createRect",imagePath:e,dataBuffer:l,annotations:g,isNew:a,data:o,relateRect:i,imageOptions:t,_viewMark:m,mdId:S},"*"),setTimeout(()=>{a&&(r=null)},500)}});